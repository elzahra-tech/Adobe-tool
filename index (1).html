<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI-Powered Metadata Generator</title>
  <script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/@xenova/transformers"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
    h1 { text-align: center; }
    .image-container { border: 1px solid #ccc; padding: 10px; background: #fff; margin-bottom: 20px; }
    .image-preview { max-width: 100px; }
    textarea { width: 100%; height: 60px; margin-top: 5px; }
    button { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>AI-Powered Metadata Generator</h1>
  <input type="file" id="imageUpload" multiple accept=".jpg,.jpeg,.png"/>
  <p id="fileCount">Number of files: 0</p>
  <div id="output"></div>
  <button onclick="downloadCSV()">Download CSV</button>

<script type="module">
  let model, processor;

  const loadModel = async () => {
    const pipeline = window.transformers.pipeline;
    const result = await pipeline('image-to-text', 'Xenova/blip-image-captioning-base');
    model = result;
  };

  await loadModel();

  const imageUpload = document.getElementById('imageUpload');
  const output = document.getElementById('output');
  const fileCountDisplay = document.getElementById('fileCount');

  const extractKeywords = (caption) => {
    const words = caption
      .replace(/[^\w\s]/g, '')
      .split(/\s+/)
      .filter((word, index, self) =>
        word.length > 2 && self.indexOf(word) === index
      );

    const filler = Array.from({length: Math.max(0, 50 - words.length)}, (_, i) => `keyword${i+1}`);
    return words.concat(filler).slice(0, 50).join(', ');
  };

  imageUpload.addEventListener('change', async (event) => {
    const files = Array.from(event.target.files);
    fileCountDisplay.textContent = 'Number of files: ' + files.length;
    output.innerHTML = '';

    for (const file of files) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = async () => {
          const captionResult = await model(img);
          const caption = captionResult[0]?.generated_text || 'No caption';
          const keywords = extractKeywords(caption);

          const container = document.createElement('div');
          container.className = 'image-container';
          container.innerHTML = `
            <img class="image-preview" src="${img.src}" alt="Preview"/><br>
            <strong>${file.name}</strong><br><br>
            <label>Title:</label>
            <textarea>${caption}</textarea>
            <br><label><strong>Keywords (50+):</strong></label>
            <textarea>${keywords}</textarea>
          `;
          output.appendChild(container);
        };
      };
      reader.readAsDataURL(file);
    }
  });

  const downloadCSV = () => {
    const rows = [['Filename', 'Title', 'Keywords']];
    const containers = document.querySelectorAll('.image-container');

    containers.forEach(container => {
      const filename = container.querySelector('strong').textContent;
      const title = container.querySelectorAll('textarea')[0].value;
      const keywords = container.querySelectorAll('textarea')[1].value;
      rows.push([filename, title, keywords]);
    });

    const csvContent = rows.map(e => e.map(s => `"${s}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'metadata.csv';
    a.click();
  };
</script>
</body>
</html>
